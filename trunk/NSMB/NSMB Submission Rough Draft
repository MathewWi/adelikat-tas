New Super Mario Bros. "any%" TAS

* Emulator used: DeSmuME v0.9.7
* Goal: any%

This is an improvement of 1884 frames (31.4 seconds) over the previous submission.

"New Super Mario Bros. was released in 2006 for the Nintendo DS. The story has been the same every time for the past 25 years: rescue some princess who can't defend for herself. So you're playing as this fat plumber, right? Because everybody else is too lazy to save her, it's up to this guy. Once again, he's gotta move through eight themed worlds to fight the evil king Bowser and save the princess. He really doesn't care about her, though - he's only in it for some cake afterward. (No point in doing it for fame anymore, anyway.)
So he effortlessly skips almost every world and gets there without the need of some huge fungi, apparently exclusive to this story. Rushing through micro-sized, beating up some Bowser minions without a thought or care, and boosting around with a cool shell he found lying around, he does so without fail... well, almost."










	Addresses

nitsuja's Lua script was very helpful with watching X and Y values. You can find it here: (link)

X Speed:    021B6A5C - Fixed Point, 4 bytes
X Position: 0208B70C - Fixed Point, 4 bytes
X Camera:   020CA2EC - Unsigned, 2 bytes
Y Speed:    021B6A61 - Signed, 1 byte
RNG 1:      02088A68 - Unsigned, 2 bytes
RNG 2:      02088A6A - Unsigned, 2 bytes


Note: This submission will refer to speed by nitsuja's Lua script, since that's what was used most of the time.










	Luck Manipulation

The starting RNG depends on the date and time you start the movie. By simply changing numbers, we can change the manipulation easily.

The RNG changes whenever certain sound effects are played, whether by Mario or the background music itself (though this depends on the level).
Luck can always be manipulated by either double jumping, throwing something, or wall jumping.
We sadly do not know exactly what the numbers in the address mean yet, so luck was usually manipulated by changing the amount of double jumps and wall jumps.

We currently know that the RNG affects:
- The world map object movements (red ? block and Hammer Bros.)
- The movement of the Scuttlebugs
- The volcano rocks in World 8-8
- When the final cutscene in World 8-Castle 2 (Bowser Jr. throwing Dry Bowser into the pot) activates










	Glitches, Tricks, and Notes

Outside of manipulation, this game is very edit-friendly. We've often rearranged parts of the movie file to compare attempts and such.

While in the Blue Shell, as long as you don't hold left or right and keep jumping, you won't lose speed.

Luigi does not affect luck at all. (You can watch this TAS with him by simply adding L and R to frame 298.)

With the Blue Shell, and at full speed while out of the shell, running down a hill for 2 frames and going into the shell while jumping will keep your speed slightly above maximum running speed (3087, compared to 3072) for as long as you stay in the shell.

For luck manipulation: To lose the least amount of speed when doing repeated double jumps, cancel a triple jump by landing on a double jump with no input for 1 frame.

You can super corner boost with the Blue Shell by coming out of it, just like "un-ducking" with big Mario.
- If you come out before hitting the block first, you will perform a midair jump.

Ducking before falling down a cliff will make you fall quicker.

You can start duck jumping/get into the Blue Shell without losing speed by running off a cliff and then starting the action.
- With the Blue Shell, try to jump and land on the very edge of the cliff.
-- After doing so, if you get out of your shell early, you can perform a midair jump.
- If you "un-duck"/get out of the shell early, you can perform a silent jump. (A silent double jump will not change the RNG.)

When wall jumping, you can save a frame by performing the wall jump a little away from the wall.
- If you push against a wall until you're able to wall jump and let go or move away from the wall, you can "store" a wall jump for about half a second.

Being able to "catch" a wall for a vertical wall jump with mini Mario seems to depend on the speed you approach it.

There is odd behavior with trying to enter pipes - sometimes, you will be stalled before being able to enter. This stall can usually be reduced by holding forward in input longer, or running along the ground into the pipe.

Try to run down hills as much as possible. Right before reaching the end of the hill, start sliding to keep your speed.
- If there is a reason you have to start sliding earlier, hold left or right while sliding (keeping down held, too). Holding left (or right) will help you gain more speed.
- When you slide off a hill and start falling, keep holding forward to keep your speed slightly higher than usual (3096, compared to 3072) until you land.

When hitting a button to raise the water level, as mini Mario, swim above the water and fall back into it. You will suddenly jump back up to the surface and will be able to walk on it.

Ground pounding off of a Broozer as mini Mario will bounce you very high.

Use screen scrolling to your advantage. Time activating moving platforms so you can run across them in the direction you want to.

In World 8-6, there are some areas where a spring pad is next to a wall. If you jump between that space and the pad and push against the wall, you'll get a vertical boost.

You can "freeze" your animation by rapidfiring in the opposite direction you're facing. (This looks very silly when doing it after a triple jump with Mario's head toward the ground.)

The hanging metal platforms in World 8-5 have odd behavior. Running while they're tilted against you will sometimes make you run faster.
- The unstable rocks act normally, however. Try to land on approximately the middle to make them tilt in favor of your running.

You can repeatedly jump off of cliffs (like in World 8-7) to keep your speed. (You can even keep jumping after landing on solid ground again to stay facing forward as long as you don't stop.)

While in water currents (currents from underwater pipes, like in World 8-3), your speed cycles. You can use this cycle to your advantage.
- Here's two pattern examples. Make sure to focus on the "xvel" value instead of the "speed" value in nitsuja's script.
- (> = hold forward (or backward - it doesn't matter in a current), (nothing) = no input; quotes mean repeat what's in the quotes)

-- For all forms except shell Mario:
--- 1152 (Start)
--- > 1244 1336 1428 1520 1612 1704 1796 1888 1980 > 2060 > 2044
--- 2136 2132 2128
--- 2124 > 2108 > 2092 > 2076 > 2060 > 2044 >
--- 2124 > 2108 > 2092 > 2076 > 2060 > 2044
--- 2136 2132 2128
--- 2124 > 2108 > 2092 > 2076 > 2060 > 2044 >
--- "2092 > 2076 > 2060 > 2044 >" (2 times)
--- (Release the rest of the time until back to 1152.)

-- For shell Mario:
--- 1728 (Start)
--- > 1808 1888 1968 2048
--- "2032 2112 2096 >" (7 times)
--- "2032 2080 2064 2048 2032 >" (2 times)
--- 2080 2064 2048 2032 2048
--- (Release the rest of the time until back to 1728.)

- What patterns you mainly want to aim for repeating the most are:

-- All forms except shell Mario:
--- Major: 2124, 2108, 2092, 2076, 2060, 2044
--- Minor: 2092, 2076, 2060, 2044

-- Shell Mario: 
--- Major: 2112, 2096, 2032
--- Minor: 2080, 2064, 2048, 2032, 2032

- Of course, this will still depend on your X position when you reach the current. Sometimes, messing up the "major" patterns can save time overall.
- What is important is that you repeat the minor cycle on the very last frame you're still in the current. (You can tell when that is by failing to reset the loop a frame later.)










	Level-By-Level Notes

  Intro:

17 frames saved because of frames mysteriously being added to the previous movie's beginning.
13 frames mysteriously saved; likely from using a different emulator.
- 30 frames ahead.



  World 1-1:

1 frame saved from more corner boosts.
21 frames saved from using the Starman to run faster.
- 52 frames ahead.



  1-1 to 1-2:

No frames saved.
- 52 frames ahead.



  World 1-2:

(Room 1)
7 frames saved from catching the ledge.
16 frames saved from super corner boosting with the Blue Shell and better speed management in the narrow passage.
8 frames saved from triple jumping off of the teeter-totter.

(Room 2)
3 frames saved from jumping to turn around after coming out of the pipe.
11 frames saved from an earlier wall jump.
- 97 frames ahead.



  1-2 to 1-Tower:

7 frames saved from better map manipulation.
- 104 frames ahead.



  World 1-Tower:

12 frames saved from getting through another passage earlier.
- 116 frames ahead.



  1-Tower to 1-Cannon:
  
17 frames saved from better map manipulation.
- 133 frames ahead.



  World 1-Cannon:
  
No frames were saved.
- 133 frames ahead.



  1-Cannon to 5-1:
  
1 frame saved from choosing "No" when asked to save by pressing right and A on the same frame.
- 134 frames ahead.



  World 5-1:
  
17 frames saved from not having to wait to manipulate luck.
- 151 frames ahead.



  5-1 to 5-2:
  
5 frames lost to manipulate the red ? block to move to World 5-B.
- 146 frames ahead.



  World 5-2:

(Room 2)
18 frames saved from super corner boosts.
1 frame saved around the multiple pipes.
3 frames saved upon the pipe entry.

(Room 3)
8 frames saved at the flagpole by making a full turn.
- 176 frames ahead.



  5-2 to 5-3:

33 frames saved from better map manipulation.
- 209 frames ahead.



  World 5-3:

11 frames saved from super corner boosting.
1 frame saved from keeping speed in the narrow passage by repeatedly jumping.
- 221 frames ahead.



  5-3 to 5-Ghost House:

38 frames saved from not having to watch the red ? block move.
- 259 frames ahead.



  World 5-Ghost House:

(Room 1)
1 frame saved from an earlier wall jump.
1 frame saved from better speed management at the Hammer Bro.
54 frames saved from ground pounding off of the Broozer and wall jumping to the next Broozer.
(133 frames saved total.) About 14 frames saved from better turning at the staircases. About 119 frames saved from ground pounding the Broozers and "activating" the Broozer next to the secret door earlier.

(Room 2)
45 frames saved in the elevator room from better usage of the vertical wall jump and taking a straight route upward.
- 493 frames ahead.



  5-Ghost House to 5-Cannon:

12 frames saved from better map manipulation.
- 505 frames ahead.



  World 5-Cannon:

No frames were saved.
- 505 frames ahead.



  5-Cannon to 8-1:

1 frame saved from choosing "No" in 1 frame.
- 506 frames ahead.



  World 8-1:

2 frames saved from corner boosting.
- 508 frames ahead.



  8-1 to 8-2:

No frames were saved.
- 508 frames ahead.



  World 8-2:

(Room 2)
8 frames saved from optimizing the water current.
25 frames saved from going above the rising water to jump and enter the pipe earlier.

(Room 3)
1 frame saved from a better wall jump. (2 frames saved from it, but 1 lost to positioning before entering the pipe at the end due to the wall jump.)

(Room 4)
11 frames saved from wall jumping.

(Room 5)
6 frames saved from avoiding pipe entry delay.

(Room 6)
2 frames saved from alternating A and B to swim up faster.
11 frames saved from avoiding pipe entry delay.

(Room 7)
24 frames saved from wall jumping up instead of using the rising water.

(Room 8)
2 frames lost to avoid a time of 255.
- 594 frames ahead.



  8-2 to 8-Tower 1:

No frames were saved.
- 594 frames ahead.



  World 8-Tower 1:

(Room 1)
82 frames saved from activating two blocks to move more in cooperation.

(Boss)
4 frames saved from a better fighting strategy.
4 frames saved from turning toward the front before the cutscene activates.
1 frame lost from having to wait for the timer to tally for another frame.
- 683 frames ahead.



  8-Tower 1 to 8-3:

33 frames saved from better map manipulation.
1 frame saved from choosing "No" in 1 frame.
- 717 frames ahead.



  World 8-3:

(Room 1)
6 frames saved from not being stopped by the ledge.
10 frames saved from avoiding pipe entry delay.

(Room 2)
27 frames saved from better cutting of corners.
42 frames saved from a combination of corner boosts and optimizing water currents.
2 frames saved from entering the pipe at a specific X position.

(Room 3)
1 frame saved from starting the wall jump a bit farther from the wall.
- 805 frames ahead.



  8-3 to 8-4:

33 frames saved from better map manipulation.
- 838 frames ahead.



  World 8-4:

2 frames saved from a super corner boost.
28 frames lost to pick up a Koopa shell.
1 frame lost from being unable to super corner boost.
28 frames lost to get the Starman.
77 frames saved from a combination of using the Starman to run faster and scrolling the screen to have the platforms move in favor.
- 860 frames ahead.



  8-4 to 8-Castle 1:

No frames were saved.
- 860 frames ahead.



  World 8-Castle 1:

(Room 1)
1 frame saved from getting on a moving platform earlier.
2 frames saved from running on the platform longer.
1 frame saved from a better super corner boost.

(Room 2)
2 frames saved from a super corner boost.
5 frames saved from landing at a specific position on the button to activate Mario's "victory" cutscene earlier.
- 871 frames ahead.



  8-Castle 1 to 8-5:

1 frame saved from choosing "No" in 1 frame.
- 872 frames ahead.



  World 8-5:

(Room 1)
4 frames saved from super corner boosting.
4 frames saved from slope optimization of platforms.
2 frames saved from entering the pipe at a specific X position.

(Room 2)
1 frame saved from an earlier wall jump.
- 883 frames ahead.



  8-5 to 8-6:

6 frames saved from better map manipulation.
- 889 frames ahead.



  World 8-6:

1 frame saved from an earlier wall jump.
3 frames saved from a better jump to the platform.
19 frames saved from wall jumping to gain speed faster.
8 frames saved from better cutting of corners.
17 frames saved from stepping on the flying Koopa earlier.
36 frames saved from a different route up the Spiny area.
- 973 frames ahead.



  8-6 to 8-7:

No frames were saved.
- 973 frames ahead.



  World 8-7:

72 frames saved from a super corner boost, and repeatedly jumping on the cliffs to keep speed.
19 frames saved from turning at the Starman earlier.
12 frames saved from running on floors and platforms more (using screen scrolling to manipulate platform timing).
6 frames saved from ducking to land on the ground near the pipe earlier.
- 1082 frames ahead.



  8-7 to 8-8:

2 frames saved from better map manipulation.
- 1084 frames ahead.



  World 8-8:

30 frames saved from turning at the invisible block earlier and wall jumping off of the block.
3 frames saved from ducking to land earlier.
- 1117 frames ahead.



  8-8 to 8-Tower 2:

1 frame lost from bad luck.
- 1116 frames ahead.



  World 8-Tower 2:

(Room 1)
683 frames saved from a new strategy by dying after activating the midpoint (approximate - this is impossible to compare directly due to map manipulation).
42 frames lost from getting a Mushroom.
42 frames lost from getting a Fire Flower.
3 frames saved from jumping to the final platform near the boss door earlier.

(Room 2)
2 frames saved from a better fighting strategy.
4 frames saved from turning toward the front before the cutscene activates.
20 frames lost from having to wait for the timer to tally longer.
- 1704 frames ahead.



  8-Tower 2 to 8-Castle 2:

4 frames saved from better map manipulation.
1 frame saved from choosing "No" in 1 frame.
- 1709 frames ahead.



  World 8-Castle 2:

(Room 2)
18 frames saved by wall jumping to gain speed faster.

(Room 3)
7 frames saved from minimal slowing down at the horizontal fire shooter.
1 frame saved from super corner boosting.

(Room 4)
29 frames saved from a different strategy.

(Room 5)
8 frames saved from wall jumping to gain speed faster.

(Room 6)

43 frames lost from getting hit.
134 frames saved from a different strategy.
27 frames saved from wall jumping to gain speed faster.

(Room 9)
3 frames saved from corner boosting off of more places.

(Boss)
1 frame saved from corner boosting.
10 frames lost to aim for the goal of ending the game earlier rather than the input (4 frames faster in hitting the button).
- 1884 frames in total.










	Known Improvements

In World 1-2, if we had more knowledge on catching walls and vertical wall jumping, a frame could probably be saved at the corner catch near the beginning by not holding back as much.

In World 5-3, 2 frames can be saved by using the Blue Shell trick for the first half of the level to stay higher than maximum running speed. This was found too late, however, and we were unable to edit the improvement in without also fixing the manipulation.

In World 5-Ghost House, we found other routes through the first room that were always ruined by the movement of the Broozers. They seem to be affected by how close you are to them. It is likely that we're missing certain paths through them to make them move in the desired way.

In World 8-Castle 1 and on, we are not sure if map manipulation is the fastest. We often counted how long timing takes by how many "flap" sounds the red ? block makes. However, when off-screen, no sounds are made. We thought this meant perfect manipulation, but we came across a few occurrences where we somehow saved more frames (even though there was no sound difference) that doubts this. (The transition in World 8-Tower 2 (after dying), however, is more likely a place we can save time, since there's a flap sound that plays there.)

(?) There are a few extra lag frames throughout the run. We have no idea how to prevent these without simply waiting. From testing, gaining them seems to depend on the frame you enter levels. For example, in World 1-2, if we entered a frame later, we wouldn't get that extra lag frame. Changing luck would not eliminate it. So, if we were to save another frame earlier in the run, we may be able to avoid this lag frame.
None of them actually lost any frames, so it's unlikely that this matters.










	(Closing comments)